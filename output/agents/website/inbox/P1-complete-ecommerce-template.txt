# P1: Complete E-commerce Template

## Objective
Make the e-commerce template export a fully functional storefront that "just works" after npm install.

---

## Part 1: E-commerce Page Templates

Create these pages in `templates/ecommerce/`:

### Required Pages
```
app/
├── page.tsx                    # Landing with featured products
├── products/
│   ├── page.tsx               # Product grid with filters
│   └── [slug]/page.tsx        # Product detail page
├── cart/page.tsx              # Cart review page
├── checkout/
│   ├── page.tsx               # Checkout flow
│   └── success/page.tsx       # Order confirmation
├── account/
│   ├── page.tsx               # User dashboard
│   ├── orders/page.tsx        # Order history
│   └── settings/page.tsx      # Account settings
└── admin/                      # If auth includes admin role
    ├── page.tsx               # Admin dashboard
    ├── products/page.tsx      # Product management
    └── orders/page.tsx        # Order management
```

### Required Components
```
components/
├── products/
│   ├── ProductCard.tsx        # Grid item
│   ├── ProductGrid.tsx        # Filterable grid
│   ├── ProductGallery.tsx     # Image gallery
│   └── ProductFilters.tsx     # Category/price filters
├── cart/
│   ├── CartDrawer.tsx         # Slide-out cart
│   ├── CartItem.tsx           # Line item
│   └── CartSummary.tsx        # Totals + checkout button
├── checkout/
│   ├── CheckoutForm.tsx       # Address + payment
│   ├── OrderSummary.tsx       # Review before pay
│   └── StripeElements.tsx     # Payment form (if Stripe selected)
└── account/
    ├── OrderHistory.tsx       # Past orders list
    └── AddressBook.tsx        # Saved addresses
```

---

## Part 2: Auto-Include Features Based on Template

Update `website/app/api/export/zip/route.ts`:

```typescript
// Template-specific feature auto-inclusion
const TEMPLATE_AUTO_FEATURES: Record<string, string[]> = {
  ecommerce: [
    "ecommerce-shopping-cart",
    "ecommerce-checkout-flow", 
    "ecommerce-order-history",
    "user-management-email-registration",
  ],
  saas: [
    "user-management-email-registration",
    "enterprise-admin-dashboard",
  ],
  dashboard: [
    "user-management-email-registration",
    "analytics-page-views",
  ],
  blog: [
    "search-filter-full-text-search",
  ],
};

// In the export function, merge auto-features with selected features
const allFeatures = [
  ...selectedFeatures,
  ...(TEMPLATE_AUTO_FEATURES[template] || []),
].filter((f, i, arr) => arr.indexOf(f) === i); // dedupe
```

---

## Part 3: Integration Bridges

Create bridge files that connect integrations:

### `templates/bridges/auth-payments.ts`
When both auth (Supabase/Clerk) and payments (Stripe) are selected:

```typescript
// lib/bridges/auth-payments.ts
import { getUser } from "@/lib/supabase/server";
import { stripe } from "@/lib/stripe";

export async function getOrCreateStripeCustomer() {
  const user = await getUser();
  if (!user) throw new Error("Not authenticated");
  
  // Check if user has Stripe customer ID
  // Create if not exists
  // Return customer ID
}

export async function createAuthenticatedCheckout(priceId: string) {
  const customerId = await getOrCreateStripeCustomer();
  return stripe.checkout.sessions.create({
    customer: customerId,
    // ... rest of checkout config
  });
}
```

### `templates/bridges/auth-email.ts`
When both auth and email are selected:

```typescript
// lib/bridges/auth-email.ts
import { sendEmail } from "@/lib/email";

export async function sendWelcomeEmail(user: { email: string; name?: string }) {
  return sendEmail({
    to: user.email,
    template: "welcome",
    data: { name: user.name || "there" },
  });
}

// Hook into auth callback
export async function onUserCreated(user: User) {
  await sendWelcomeEmail(user);
}
```

---

## Part 4: Update Export Logic

In `website/app/api/export/zip/route.ts`, add bridge detection:

```typescript
// Detect which bridges are needed
const bridges: string[] = [];

if (integrations.auth && integrations.payments) {
  bridges.push("auth-payments");
}
if (integrations.auth && integrations.email) {
  bridges.push("auth-email");
}
if (integrations.payments && integrations.email) {
  bridges.push("payments-email"); // Order confirmation emails
}

// Include bridge files in export
for (const bridge of bridges) {
  const bridgePath = `templates/bridges/${bridge}.ts`;
  if (fs.existsSync(bridgePath)) {
    zip.file(`lib/bridges/${bridge}.ts`, fs.readFileSync(bridgePath));
  }
}
```

---

## Part 5: E-commerce Data Layer

Create `templates/ecommerce/lib/`:

```typescript
// lib/products/types.ts
export interface Product {
  id: string;
  name: string;
  slug: string;
  description: string;
  price: number;
  compareAtPrice?: number;
  images: string[];
  category: string;
  variants?: ProductVariant[];
  inventory: number;
  status: "active" | "draft" | "archived";
}

// lib/products/api.ts
export async function getProducts(filters?: ProductFilters): Promise<Product[]>
export async function getProduct(slug: string): Promise<Product | null>
export async function searchProducts(query: string): Promise<Product[]>

// lib/orders/types.ts
export interface Order {
  id: string;
  userId: string;
  items: OrderItem[];
  subtotal: number;
  tax: number;
  shipping: number;
  total: number;
  status: "pending" | "paid" | "shipped" | "delivered" | "cancelled";
  shippingAddress: Address;
  createdAt: Date;
}

// lib/orders/api.ts
export async function createOrder(cart: CartItem[], userId: string): Promise<Order>
export async function getOrders(userId: string): Promise<Order[]>
export async function getOrder(orderId: string): Promise<Order | null>
```

---

## Validation Checklist

After implementation, T08 (E-commerce Full Stack) should:
- [ ] Export with all product pages
- [ ] Include cart functionality
- [ ] Have working checkout → Stripe
- [ ] Send order confirmation via Resend
- [ ] Track events in PostHog
- [ ] Build without errors
- [ ] Display products on homepage

---

## Priority: P1
## Estimated Effort: 2-3 sessions
## Dependencies: None (can start immediately)

